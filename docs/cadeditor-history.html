<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">

    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-dark.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/cadeditor.css" media="screen">

    <title>История развития редактора CadEditor</title>
  </head>

  <body>

    <header>
      <div class="container">
        <h1>История развития редактора CadEditor</h1>
        <h2>Основные этапы разработки редактора</h2>
      </div>
    </header>

<div class="container">
  <section id="main_content">

<p>
<h2> 0. Мой опыт исследователя игр</h2>
Я увлекся исследованием игр практически сразу, как открыл для себя возможность эмуляции игр на компьютере. Я пропустил период, в который создавались эмуляторы, и собиралась база дампов ROM-файлов популярных игр - они были доступны в сети.
</p>

<p>
Изначально меня интересовали секреты в играх - содержащийся в играх неиспользованный контент, коды для перехода в режим отладки для тестов игры, системы паролей, малоизвестные игрокам секретные места и бонусы. Большая часть такого материала уже была найдена авторами дампов и ромхакерами и выложена в сети, но я наткнулся на то, что открыто и исследовано ещё далеко не всё.
</p>

<p>
Вот ссылки на некоторые мои исследования:
<ul>
<li><a href="https://spiiin.livejournal.com/33614.html">Tecmo World Cup password system</a></li>
<li><a href="https://spiiin.livejournal.com/35158.html">Goal! Two password system</a></li>
<li><a href="https://spiiin.livejournal.com/60086.html">Adventure Island 2 random level select system</a></li>
<li><a href="https://spiiin.livejournal.com/6011.html">Battletoads regional version differences</a></li>
<li><a href="https://spiiin.livejournal.com/45469.html">Addams Family doors system</a></li>
</ul>
</p>

</p>
Одним из первых моих открытий стало то, что в игре <b class="gamename">New Ghostbusters 2 [NES]</b> разработчики спрятали множество бонусов, которые можно получить, если ловить призраков в определённом порядке. Я узнал это, когда исследовал код поведения врагов в игре. Я нашёл предмет "мешок с деньгами", у которого в свойствах сохранялась цепочка врагов, которую нужно поймать в правильном порядке, чтобы он появился. Вот видео, в котором враги ловятся в правильном порядке, открывающим все бонусы:
</p>

<p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/L90WP3TiEhI" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
</p>

<p>
Одной из моих идей исследования игр стало построение карты уровней по бинарным данным, хранящимся в ROM-файле. С большим трудом, потратив несколько недель, я смог получить карту уровней игры <b class="gamename">Jungle Book</b>. Однако, в ходе исследования, я понял, что могу повторить этот процесс с другими играми. Меня интересовала, по большей части, только возможность получить карту, но в это время я наткнулся на ромхакера с ником <b class="nickname">Lomax</b>, который создавал хаки классических игр с изменёнными уровнями и боссами. Он использовал для изменения уровней Hex-редактор. Я написал ему, что могу сделать визуальный редактор уровней для игры <b class="gamename">Chip & Dale</b> (к тому моменту я уже частично разобрал устройство уровней в ней), и он очень заинтересовался этой идеей.
</p>

<p>
Таким образом, я начал работать над прототипом <b>CadEditor</b>, для того, что дать возможность изменять уровни в игре <b class="gamename">Chip & Dale</b>.
</p>

<p>
<h2>1. Редактор Чипа и Дейла и Чёрного Плаща</h2>
Я распространял первые версии редактора через форум <a href="https://www.emu-land.net/forum/">emu-land</a>, и получил много отзывов с предложениями улучшений и найденными недоработками редактора. Постепенно я добавлял необходимые фичи - редактирование блоков, рендер графики с помощью банков CHR так, как это делает видеопроцессор консоли, редакторование объектов и параметров уровней. Одновременно с этим я обнаружил, что игра <b class="gamename">Darkwing Duck</b> использует такую же систему хранения уровней, и даже часть данных в ROM-файле находится по таким же смещениям. Оказалось, что немного изменив редактор, можно добавить в него поддержку этой игры.
</p>

<p>
К этому моменту пользователи редактора использовали редактор, чтобы создать хаки для этих 2 игр:
ссылки на хаки.
</p>
<p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/avoHbLNK-D0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
</p>
<p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/iYEfjrr_XD8" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
</p>

<p>
<h2>2. Редактор Capcom-игр</h2>
Меня заинтересовало - если игры <b class="gamename">Chip & Dale</b> и <b class="gamename">Darkwing Duck</b> оказались так похожи, то, возможно, получится добавить и редактор и другие игры <b>Capcom</b>?
</p>
<p>
Я исследовал формат уровней игр <b class="gamename">Duck Tales 1/2</b>, <b class="gamename">Tale Spin</b> и <b class="gamename">Little Mermaid</b>, и заметил, что они достаточно похожи по формату уровней между собой. Однако, все они имели мелкие отличия, которые не позволяли просто добавить их в редактор, просто изменив адреса хранения данных (за исключением <b class="gamename">Tale Spin</b> - в ней формат полностью совпадает с <b class="gamename">Darkwing Duck</b>).
</p>

<p>
Я размышлял над тем, каким образом добавить эти игры в редактор, так чтобы иметь возможность расширять его. Очевидно было, что необходимо вынести все адреса данных в конфигурационный файл. Но как описать способ загрузки данных, формат хранения которых заранее неизвестен? Одно из возможных решений - встроить в редактор интерпретацию скриптового языка программирования, на котором и будут описываться способы загрузки данных из игр.
</p>

<p>
Таким образом, пользователи смогут реализовывать любые функции загрузки данных для различных игр. Я написал сам редактор на C#, и в качестве скриптового языка выбрал библиотеку <a href="http://www.csscript.net/">CSScript</a>, которая позволяет писать скрипты также на C#. Это язык не самый простой или лаконичный, но выбор C# позволил легко переносить код и редактора в скриптовые настройки и обратно без изменений. Конечно, первые версии скриптовой библиотеки не позволяли настраивать поддержку каких угодно игр и часть логики всё равно присутствовала внутри кода редактора.
</p>

<p>
Но с помощью этого подхода удалось добавить в редактор поддержку всех вышеперечисленных игр Capcom:
<img src="images/his_mermaid.png" class="center-img">
<img src="images/his_talespin.png" class="center-img">
<img src="images/his_mm4.png" class="center-img">
</p>

<p>
<h2>3. Редактор игр с подготовленными картинками блоков.</h2>
Я попробовал исследовать игры от других разработчиков и разобраться, каким образом описаны уровни в них. Одной из общих формулировок было - почти все игры используют блоки (описыванные различными способами) и массив-карту, которая содержит индексы этих блоков. Этот подход можно было перенести в редактор - если не разбираться в устройстве блоков, а просто подготовить скриншоты каждого блока на уровне, можно отобразить карту из заранее подготовленных картинок и дать возможность изменять её. Кроме того, такой подход позволял портировать конфиги игр из других редакторов уровней.
</p>

<p>
В ходе обновлений редактора я подготовил картинки для блоков из нескольких игр разных разработчиков - <b class="gamename">Jungle Book</b>, <b class="gamename">Tiny Toon Adventures</b>, <b class="gamename">Tom & Jerry</b>, <b class="gamename">Battletoads</b>.
</p>

<p>
После этого у меня в первый раз возникла идея создания редактора, который с помощью конфигов мог бы работать с любой игрой. Для этого требовалось изучить формат уровней большого количества игр, не вникая в подробное устройство каждой. Следущие версии редактора добавляют новые описательные возможности редактору.
</p>

<p>
<h2>4. Универсальный блочный редактор</h2>
Я понемногу добавлял в редактор возможности описывать различные форматы блоков и экранов.
В версиях 1.9-1.9.5 добавлена возможность описывать игры, в которых экраны строятся не построчно, а постолбцово. Кроме того, добавлена возможность использования не только квадратных блоков, но и прямоугольных. Это позволило к версии 2.0 добавить в редактор уже 32 игры (по одному уровню из каждой для тестов).
<img src="images/his_flintstones_2.png" class="center-img">
</p>
<p>
После этого я обнаружил, что с помощью редактора картинок можно отображать и уровни игр для платформы <b>Sega Mega Drive</b> и добавил несколько уровней для неё (<b class="gamename">Tiny Toon</b>, <b class="gamename">Contra Hard Corps</b>, <b class="gamename">QuackShot</b>). Далее развитие редактора шло путём исследования и добавления новых игр, большинство из которых не требовало никаких дополнительных усилий - нужно было лишь заготавливать картинки блоков.
<img src="images/his_tinytoon.png" class="center-img">
</p>

<p>
Однако это была рутинная работа, требующая много времени, поэтому к этому моменту я написал несколько скриптов для автоматизации действий. Я назвал проект <b>Autocorrupter</b> - скрипт, который позволяет получать картинки каждого блока на уровне. Этот скрипт также со временем развивался и улучшался. Частично это потребовало написания кода и внесения изменений в сам эмулятор <b><i>Fceux</i></b> (в настоящий момент изменения включены в последнюю версию эмулятора).
</p>

<p>
В этот момент интерес пользователей к редактору немного угас, потому что я был полностью поглощен добавлением и исследованием новых игр и не занимался расширением поддержки уже ислледованных игр. Однако некоторые пользователи разделяли мои идеи и помогали мне. К версии 3.0, хакер с ником <b class="nickname">Mephisto</b> взял исходный код моего редактора и портировал его для создания редактора <b class="gamename">Thunder Force 3 [SMD]</b>. Он не использовал редактор картинками, а написал код построения блоков. Я портировал его код обратно в свой редактор и это дало мне возможность описывать блоки для игры платформы <b>Sega Mega Drive</b>
<img src="images/tut2_tf3_editor.png">
</p>

<p>
<h2>5. Система плагинов</h2>
Редактор к этому моменту оброс огромным количеством кода (частично устарешего - написанного для конкретных игр, а не для обобщённого редактора) и я понял, что проект стал настолько сложным, что я скоро не смогу контроллировать его. 
</p>
<p>
Я стал думать о том, как упростить код и разбить проект на отдельные части. 
</p>
<p>
Игры для NES и SMD использовали отдельный код для построения графики и редактирования блоков (есть некоторые специфичные для платформы отличия - так что редактирование происходит немного по разному). Поэтому я решил добавить в редактор систему плагинов - общий код, используемые для любой игры оставался в ядре редактора, а специфичные для платформы и игры вещи выносились в отдельные сборки (в виде DLL-файлов), которые редактор подгружал уже после открытия файла с настройками игры.
</p>

<p>
Например, при открытии настроек игры <b class="gamename">Chip & Dale</b> - редактор подгружал плагины построения NES-графики, а также плагин редактирования параметров дверей, специфичный именно для этой игры. Для сеговской <b class="gamename">Contra Hard Corps</b> - редактор подгружал плагин построения SMD-графики и специальный редактор заднего фона, присутствующий для всех SMD-игр. При этом в ядре редактора всегда оставались доступны редакторы экранов, объектов и блоков. Это позволило улучшить архитектуру, и уменьшить количество кода в основном проекте.
</p>

<p>
<h2>6. Проверка различных NES-игр</h2>
Также я обнаружил большой класс игр, которые используют одинаковый формат блоков из 17 байт - 16 тайлов и 1 байт палитры. Позже я понял, что это естественное описание для платформы NES. Я добавил поддержку построения таких блоков, что позволило вновь пройти по тем играм, которые были описаны с помощью картинок блоков, и переписать их с помощью использования таких блоков. Вот несколько примеров построения конфигов игр с такими блоками:
<ul>
<li><b class="gamename">Power Blade 1-2</b></li>
<li><b class="gamename">Adventure Island 2-3</b></li>
<li><b class="gamename">Yo-Noid</b></li>
<li><b class="gamename">Jackie Chan Action Kung Fu</b></li>
<li><b class="gamename">Contra Force</b></li>
<li><b class="gamename">Batman Returns</b></li>
<li><b class="gamename">Super C</b></li>
<li><b class="gamename">Monster in My Pocket</b></li>
<li><b class="gamename">Bucky O'Hare</b></li>
<li><b class="gamename">Jackal</b></li>
<li><b class="gamename">Teenage Mutant Ninja Turtles 1-3</b></li>
<li><b class="gamename">Alien 3</b></li>
<li><b class="gamename">Battletoads</b></li>
<li><b class="gamename">Battletoads & Double Dragon</b></li>
<li><b class="gamename">Darkman</b></li>
<li>Множество других</li>
</ul>
</p>

<p>
Примеры построения конфигов для игр с такими блоками:<br>
<a href="tutorial-powerblade2.html">Teenage Mutant Ninja Turtles 2</a><br>
<a href="tutorial-tmnt2.html">Power Blade 2</a><br>
</p>

<p>
Для поиска блоков в ROM-файле я придумал алгоритм, который позволил искать стандартные блоки автоматически, анализируя видеопамять в эмуляторе. Это позволило сильно ускорить процесс поиска. Этот алгоритм реализован в виде Lua-скрипта под названием <b>BlockFinder</b> для эмулятора Fceux. В паре скрипты <b>Autocorrupter</b> и <b>BlockFinder</b> позволили добавлять в редактор поддержку новых игр очень быстро.
</p>

<p>
С помощью новых инструментов и расширения возможностей редактора по описанию блоков было добавлены большое число игр. К проекту подключился <b class="nickname">Lancuster</b>, который добавлял все уровни для тех игр, в которых я создавал только 1 тестовый конфиг. Он нашёл более 100 игр с форматами, подобными уже добавленным, и описал их. Суммарное количество игр, для которых реализована поддержка редактирования экранов и блоков, приблизилось к 200.
</p>

<p>
<h2>7. Будущее</h2>
Система конфигов и плагинов редактора CadEditor, а также инструменты для поиска блоков в ROM-файлах, позволяет описывать практически любую игру.
</p>
<p>
Однако, кроме модулей редактора экранов и блоков, для удобного изменения игр также необходимо добавления редактора объектов. Редактор поддерживает обобщённое описание для списков объектов, но большинство игр пока ожидают добавления в него.
</p>
<p>
Кроме того, большинство исследований касались только NES игр, хотя подобные принципы поиска и добавления могут быть применены для любых платформ с тайловой графикой - <b>Sega Mega Drive, SNES, Game Boy, Game Boy Advance, Sega Master System, старые PC-игры</b>.
</p>
<p>
Интересной возможностью является использование редактора с полностью пересобираемыми исходниками игры (работа с asm-файлами). Система плагинов редактора позволяет реализовать систему сборки с использованием внешних утилит, включая ассемблер, экспорт и компрессию данных.
</p>
<p>
Но моей основной целью, прежде всего, является сохранение в редакторе истории старых игр, а также исследование и документирование использованных разработчиками решений. Именно для этого я трачу своё время на этот проект.
</p>

<p>
<a href="https://steemit.com/utopian-io/@pinkwonder/cadeditor-history-of-the-project">Английская версия статьи на сайте steemit</a>
</p>
  </section>
  </div>
  
   <div class="dashed">
   <div class="container" align="center">
   <a href="index.html" align="right">Назад</a>
   </div>
   </div>
  </body>
</html>
